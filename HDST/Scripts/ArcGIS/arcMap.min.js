function initMap(n) { n.Layers = []; $.getScript("./ARCGIS/XDCustDrawlayer" + jsMin + ".js", function () { n.CustDrawLayer = new XDCustDrawLayer(n, "cust") }); $.getScript("./ARCGIS/wkt-arcgis" + jsMin + ".js"); $.getScript("./ARCGIS/jsonConverters" + jsMin + ".js"); $.getScript("./ARCGIS/Measure" + jsMin + ".js", function () { n.DrawTool = new MeasureInit }); n.getGraphicsLayer = function (t) { var i; return n.getLayer(t) != null ? i = n.getLayer(t) : (i = new esri.layers.GraphicsLayer({ id: t, opacity: 1 }), n.addLayer(i)), i }; n.addLayersFromConfig = function (t) { $.ajax({ url: t, type: "GET", dataType: "xml", timeout: 1e3, error: function (n) { console.log("讀取xml錯誤" + n); location.reload() }, ajaxError: function () { console.log("ajaxError") }, success: function (t) { var f = xmlToJson(t), h, r, e, u, s, o; n.Parameters = f.Parameters; for (i in f.Parameters.LayerItems.Item) h = f.Parameters.LayerItems, r = f.Parameters.LayerItems.Item[i], r.Type["#text"] == "TiledLayer" ? (e = r.URL["#text"].split("MapServer/"), u = new esri.layers.ArcGISTiledMapServiceLayer(r.URL["#text"], { id: r.ID["#text"] }), u.setVisibility(!1), u.name = r.ID["#text"], n.addLayer(u)) : (r.Type["#text"] == "DynamicLayer" || r.Type["#text"] == "FeatureLayer") && (e = r.URL["#text"].split("MapServer/"), u = new esri.layers.ArcGISDynamicMapServiceLayer(e[0] + "MapServer", { id: r.ID["#text"] }), u.setVisibleLayers([Number(e[1])]), u.setVisibility(!1), u.name = r.ID["#text"], s = u.url, u.IdentifyTask = new esri.tasks.IdentifyTask(s), n.addLayer(u)); if (o = window.parent, o.onMapOpened != undefined) o.onMapOpened(n) }, complete: function () { } }) }; n.addWMTSLayer = function (t, i, r, u, f) { $.getScript("./ARCGIS/XDWMTSLayer.js", function () { var o = new XDWMTSLayer(t, i), e; return o.id = r, n.addLayer(o), o.setVisibility(u), e = { LayerName: r, isShow: u, baseLayer: o, LayerID: o.id, isSelectable: !1 }, e.GeoType = 100, e.setShow = function (n) { this.isShow = n; this.baseLayer.setVisibility(n) }, e.isTile = !0, n.Layers.push(e), f != null && f(), e }) }; n.addArcGISTileLayer = function (t, i, r, u, f) { var e = new esri.layers.ArcGISTiledMapServiceLayer(t), o; return e.name = i, e.id = i, e.setVisibility(r), o = { LayerName: e.name, isShow: r, baseLayer: e, LayerID: e.id, isSelectable: !1 }, o.GeoType = 100, o.setShow = function (n) { this.isShow = n; this.baseLayer.setVisibility(n) }, o.isTile = !0, n.Layers.push(o), n.addLayer(e), f != null && f(), o }; n.addArcGISFeatureLayer = function (t, i, r, u, f, e) { var o = new esri.layers.FeatureLayer(t, { id: i, outFields: ["*"] }), s, a, c, v, l, h; if (o.setVisibility(r), o.name = i, i == "水門" || i == "都市計畫使用分區" || i == "道路名稱(1:5000顯示)" || i == "門牌" || i == "村里" || i == "鄉鎮市") { switch (i) { case "水門": s = "{Name}"; break; case "都市計畫使用分區": s = "{Use_}"; break; case "道路名稱(1:5000顯示)": s = "{ROADNAME}"; break; case "門牌": s = "{ADDRESSALL}"; break; case "村里": s = "{VILLNAME}"; break; case "鄉鎮市": s = "{TOWNNAME}" }a = new esri.Color("#000000"); c = (new esri.symbol.TextSymbol).setColor(a); c.font.setSize("15pt"); c.font.setFamily("arial"); v = { labelExpressionInfo: { value: s } }; l = new esri.layers.LabelClass(v); l.symbol = c; o.setLabelingInfo([l]); n.addLayer(o) } else n.addLayer(o); h = { LayerName: o.name, isShow: o.visible, baseLayer: o, LayerID: o.id, isTile: !0 }; n.Layers.push(h); h.setShow = function (n) { this.isShow = n; this.baseLayer.setVisibility(n) }; o.on("load", function () { $.getJSON(t + "?f=pjson", function (n) { var t; try { t = n.drawingInfo.renderer.symbol.imageData } catch (i) { } h.icon = t; e != null && e() }) }); return h }; n.addArcGISFeatureLayer2 = function (t, i, r, u, f, e) { var o = new esri.layers.ArcGISDynamicMapServiceLayer(t, { id: i, outFields: ["*"] }), s, a, c, v, l, h; o.setVisibility(r); o.name = i; i == "水門" || i == "都市計畫使用分區" || i == "道路名稱(1:5000顯示)" || i == "門牌" || i == "村里" || i == "鄉鎮市" ? (i == "水門" ? s = "{Name}" : i == "都市計畫使用分區" ? s = "{Use_}" : i == "道路名稱(1:5000顯示)" ? s = "{ROADNAME}" : i == "門牌" ? s = "{ADDRESSALL}" : i == "村里" ? s = "{VILLNAME}" : i == "鄉鎮市" && (s = "{TOWNNAME}"), a = new esri.Color("#000000"), c = (new esri.symbol.TextSymbol).setColor(a), c.font.setSize("15pt"), c.font.setFamily("arial"), v = { labelExpressionInfo: { value: s } }, l = new esri.layers.LabelClass(v), l.symbol = c, o.setLabelingInfo([l]), n.addLayer(o)) : n.addLayer(o); h = { LayerName: o.name, isShow: o.visible, baseLayer: o, LayerID: o.id, isTile: !0 }; n.Layers.push(h); h.setShow = function (n) { this.isShow = n; this.baseLayer.setVisibility(n) }; o.on("load", function () { $.getJSON(t + "?f=pjson", function (n) { var t; try { t = n.drawingInfo.renderer.symbol.imageData } catch (i) { } h.icon = t; e != null && e() }) }); return h }; n.addArcGISLayer = function (t, i, r, u, f, e) { var o = new esri.layers.ArcGISDynamicMapServiceLayer(t, { id: i }), s; o.setVisibility(r); o.name = i; n.addLayer(o); s = { LayerName: o.name, isShow: o.visible, baseLayer: o, LayerID: o.id, isTile: !1 }; n.Layers.push(s); s.setShow = function (n) { this.isShow = n; this.baseLayer.setVisibility(n) }; o.on("load", function () { $.getJSON(t + "/legend?f=json", function (t) { var i; o.setVisibleLayers([]); for (i in t.layers) o.layerInfos[t.layers[i].layerId].legend = t.layers[i].legend; for (i in o.layerInfos) o.layerInfos[i].oLayerName = o.name, o.layerInfos[i].setShow = function (t) { var i = n.FindLayer(this.oLayerName), u, r; this.visible = t; t && i.setShow(t); u = []; for (id in i.baseLayer.layerInfos) i.baseLayer.layerInfos[id].visible && u.push(id); i.baseLayer.setVisibleLayers(u); this.zTreeID != undefined && (r = n.LayerControl.getZtree().getNodesByParam("zTreeID", this.zTreeID), r.length > 0 && (r[0].checked = t, n.LayerControl.getZtree().updateNode(r[0]))) }; e != null && e() }) }); return s }; n.exportMap = function (t, i, r, u) { var e; if (r == "是") { var o = "https://wragis.e-land.gov.tw/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task", s = new esri.tasks.PrintTask(o), f = new esri.tasks.PrintTemplate; f.exportOptions = { width: 1024, height: 768, dpi: 96 }; f.format = t; f.layout = "Letter ANSI A Portrait"; f.preserveScale = !0; f.layoutOptions = { legendLayers: [], scalebarUnit: "Miles", titleText: i }; e = new esri.tasks.PrintParameters; e.map = n; e.template = f; s.execute(e, u) } else { var o ="https://wragis.e-land.gov.tw//arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",s=new esri.tasks.PrintTask(o),f=new esri.tasks.PrintTemplate;f.exportOptions={width:1024,height:768,dpi:96};f.format=t;f.layout="Letter ANSI A NoPortrait";f.preserveScale=!0;f.layoutOptions={legendLayers:[],titleText:i};e=new esri.tasks.PrintParameters;e.map=n;e.template=f;s.execute(e,u)}};n.FindLayer=function(n){var r,t,u;if(n.toString().indexOf(".")>0){r=n.toString().split(".");for(i in r)t==null?t=this.FindLayer(r[i]):t.baseLayer.layerInfos!=undefined?(u=this.DeepFind(r[i],t.baseLayer.layerInfos),u.oLayerName=t.LayerName,t=u):t=this.DeepFind(r[i],t.Items);return t}return this.DeepFind(n,this.Layers)};n.DeepFind=function(n,t){var r,u,i;for(u in t){if(i=t[u],n==i.LayerID||n==i.LayerName||n==i.id||n==i.name)return i;if(i.Items!=null){if(r=this.DeepFind(n,i.Items),r!=null)return r}else if(i.isTile==!1&&i.baseLayer!=null&&i.baseLayer.layerInfos!=undefined&&(r=this.DeepFind(n,i.baseLayer.layerInfos),r!=null))return r}};n.fitBounds=function(t){var i,r,u,f;t!=null&&(i=1e3,r=1e3,t.getWidth()==0&&t.getHeight()==0?(i=100,r=100):(u=30,i=t.getWidth()*(u/100),r=t.getHeight()*(u/100)),f=new esri.geometry.Extent(t.xmin-i/2,t.ymin-r/2,t.xmax+i/2,t.ymax+r/2,n.spatialReference),n.setExtent(f))};n.QueryByFilter=function(t,r,u,f,e){var h="",s,c,o,l;t.indexOf("http://")>=0?h=t:(s=n.FindLayer(t),s==null&&alert("找不到圖層"),s.oLayerName!=undefined&&(c=n.getLayer(s.oLayerName)),h=c.url+"/"+s.id);o=new esri.tasks.Query;l=new esri.tasks.QueryTask(h);o.where=r;o.returnGeometry=!0;o.outFields=f.split(",");o.outSpatialReference={wkid:102100};l.execute(o,function(n){var t,r;for(i in n.features)r=n.features[i],t=t==null?r.geometry.getExtent():t.union(r.geometry.getExtent());e(n.features,t)})};n.QueryByFilter2=function(){};n.QueryByFilter3=function(t,i,r,u,f){var s="",e,h,o,c;t.indexOf("http://")>=0?s=t:(e=n.FindLayer(t),e==null&&alert("找不到圖層"),e.oLayerName!=undefined&&(h=n.getLayer(e.oLayerName)),s=h.url+"/"+e.id);o=new esri.tasks.Query;c=new esri.tasks.QueryTask(s);o.where=i;o.returnGeometry=!1;o.outFields=u.split(",");c.execute(o,function(n){console.log(n);f(n)})};n.QueryByFeature=function(t,r,u,f){var s="",e,h,o,c;t.indexOf("http://")>=0?s=t:(e=n.FindLayer(t),e==null&&alert("找不到圖層"),e.oLayerName!=undefined&&(h=n.getLayer(e.oLayerName)),s=h.url+"/"+e.id);o=new esri.tasks.Query;c=new esri.tasks.QueryTask(s);o.geometry=r;o.returnGeometry=!0;o.outFields=["*"];c.execute(o,function(n){var t,r;for(i in n.features)r=n.features[i],t=t==null?r.geometry.getExtent():t.union(r.geometry.getExtent());f(n.features,t)})};n.addTGosMap=function(){$.getScript("./ARCGIS/SGSArcGISServer.js",function(){var t=new SGSTileLayer("http://api.tgos.nat.gov.tw/TileAgent/TGOSMAP_W.aspx","",0,!0),i,r,u;t.id="TGOSMAP_W";t.minScale=2311162;t.minScale=2257;n.addLayer(t,0);t.hide();i=new SGSTileLayer("http://api.tgos.nat.gov.tw/TileAgent/ROADMAP_W.aspx","",0,!0);i.id="ROADMAP_W";n.addLayer(i,0);i.hide();r=new SGSTileLayer("http://api.tgos.nat.gov.tw/TileAgent/NLSCMAP_W.aspx","",0,!0);r.id="NLSCMAP_W";n.addLayer(r,0);r.hide();u=new SGSTileLayer("http://api.tgos.nat.gov.tw/TileAgent/F2IMAGE_W.aspx","",0,!0);u.id="F2IMAGE_W";n.addLayer(u,0);u.hide()})}}var jsMin=document.scripts[document.scripts.length-1].src.indexOf(".min.js")>0?".min":"";
